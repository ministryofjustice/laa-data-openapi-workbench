openapi: "3.0.0"
info:
  version: 1.0.0
  title: Data Stewardship Access API

paths:
  /api/v0/applications:
    get:
      tags:
        - application
      summary: Get applications
      operationId: getApplications
      parameters:
        - $ref: "#/components/parameters/XServiceName"
        - in: query
          name: status
          description: The current overall status of the applications' decision.
          schema:
            $ref: "#/components/schemas/applicationStatus"
        - in: query
          name: laaReference
          description: The LAA reference number of the application
          schema:
            type: string
        - in: query
          name: clientFirstName
          description: The client first name
          schema:
            type: string
        - in: query
          name: clientLastName
          description: The client last name
          schema:
            type: string
        - in: query
          name: clientDateOfBirth
          description: The linked individuals date of dateOfBirth
          schema:
            type: string
            format: date
        - in: query
          name: userId
          description: The caseworkers id
          schema:
            type: string
            format: uuid
        - in: query
          name: isAutoGranted
          description: Has the application been marked as auto granted
          schema:
            type: boolean
        - in: query
          name: matterType
          description: The matter type of the application
          schema:
            $ref: "#/components/schemas/matterType"
        - in: query
          name: sortBy
          description: The field name to sort by if sorting required (defaults to SUBMITTED_DATE)
          schema:
            $ref: "#/components/schemas/applicationSortBy"
        - in: query
          name: orderBy
          description: The order to sort by if sorting required (defaults to ASC)
          schema:
            $ref: "#/components/schemas/applicationOrderBy"
        - in: query
          name: page
          description: Page number of data to be returned (defaults to 1)
          schema:
            type: integer
            default: 1
        - in: query
          name: pageSize
          description: Number of applications in a page (defaults to 20)
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: 'Success'
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplicationSummaryResponse"
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '500': { description: Internal server error }
    post:
      tags:
        - application
      summary: Create an application
      operationId: createApplication
      parameters:
        - $ref: "#/components/parameters/XServiceName"
      requestBody:
        description: Create an application (all fields inside `applicationContent`)
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApplicationCreateRequest"
      responses:
        '201': { description: Created }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '500': { description: Internal server error }

  /api/v0/applications/{id}:
    get:
      tags:
        - application
      summary: Get an application by id
      operationId: getApplicationById
      parameters:
        - $ref: "#/components/parameters/XServiceName"
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Application"
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '500': { description: Internal server error }
    patch:
      tags:
        - application
      summary: Update an application
      operationId: updateApplication
      parameters:
        - $ref: "#/components/parameters/XServiceName"
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        description: Partial update of application (all fields inside `applicationContent`)
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApplicationUpdateRequest"
      responses:
        '200': { description: Success }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '409': { description: Conflict }
        '500': { description: Internal server error }

  /api/v0/caseworkers:
    get:
      tags:
        - caseworkers
      summary: Get list of caseworkers
      operationId: getCaseworkers
      parameters:
        - $ref: "#/components/parameters/XServiceName"
      responses:
        '200':
          description: 'Success'
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CaseworkerResponse"
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '500': { description: Internal server error }

  /api/v0/applications/{id}/history-search:
    get:
      tags:
        - application
      summary: Get a list of events associated with an application
      operationId: getApplicationHistory
      parameters:
        - $ref: "#/components/parameters/XServiceName"
        - in: path
          name: id
          description: "the ID of the application to get history format"
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: eventType
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/domainEventType"
      responses:
        '200':
          description: 'Success'
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplicationHistoryResponse"
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '500': { description: Internal server error }

  /api/v0/applications/assign:
    post:
      tags:
        - application
      operationId: assignCaseworker
      parameters:
        - $ref: "#/components/parameters/XServiceName"
      summary: Assign a caseworker to one or more applications.
      requestBody:
        description: Assign the supplied caseworker to one or more applications.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CaseworkerAssignRequest'
      responses:
        '200': { description: OK }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '500': { description: Internal server error }

  /api/v0/applications/{id}/unassign:
    post:
      tags:
        - application
      operationId: unassignCaseworker
      summary: Unassign a caseworker from an application
      parameters:
        - $ref: "#/components/parameters/XServiceName"
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        description: Optional event history describing the unassignment action
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CaseworkerUnassignRequest'
      responses:
        '200': { description: OK }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '500': { description: Internal server error }

  /api/v0/applications/{id}/decision:
    patch:
      tags:
        - application
      operationId: makeDecision
      summary: Make a decision request for an application
      parameters:
        - $ref: "#/components/parameters/XServiceName"
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        description: event history describing the create decision action
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MakeDecisionRequest'
      responses:
        '200': { description: OK }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '500': { description: Internal server error }
  /api/v0/individuals:
    get:
      tags:
        - individuals
      summary: Get a list of individuals matching search criteria
      operationId: getIndividuals
      parameters:
        - $ref: "#/components/parameters/XServiceName"
        - name: page
          in: query
          description: Page number of data to be returned (defaults to 1)
          schema:
            type: integer
            default: 1
        - name: pageSize
          in: query
          description: Number of individuals in a page (defaults to 20)
          schema:
            type: integer
            default: 20
        - name: applicationId
          in: query
          description: The ID of the application the individuals are linked to
          schema:
            type: string
            format: uuid
        - name: individualType
          in: query
          description: The type of the individual
          schema:
            $ref: "#/components/schemas/individualType"
      responses:
        '200':
          description: 'Success'
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IndividualsResponse"
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '500': { description: Internal server error }
components:
  parameters:
    XServiceName:
      in: header
      name: X-Service-Name
      required: true
      schema:
        $ref: "#/components/schemas/serviceName"
  schemas:
    serviceName:
      type: string
      enum:
        - CIVIL_APPLY
        - CIVIL_DECIDE
      description: Service name
    applicationStatus:
      type: string
      enum:
        - APPLICATION_IN_PROGRESS
        - APPLICATION_SUBMITTED
      description: Application statuses
    domainEventType:
      type: string
      enum:
        - APPLICATION_CREATED
        - APPLICATION_UPDATED
        - ASSIGN_APPLICATION_TO_CASEWORKER
        - UNASSIGN_APPLICATION_TO_CASEWORKER
        - APPLICATION_MAKE_DECISION_REFUSED

    categoryOfLaw:
      type: string
      enum:
        - FAMILY

    matterType:
      type: string
      enum:
        - SPECIAL_CHILDREN_ACT
    applicationType:
      type: string
      enum:
        - INITIAL
      default: INITIAL

    individualType:
      type: string
      enum:
        - CLIENT

    applicationSortBy:
      type: string
      enum:
        - LAST_UPDATED_DATE
        - SUBMITTED_DATE

    applicationOrderBy:
      type: string
      enum:
        - ASC
        - DESC

    Individual:
      type: object
      required:
        - firstName
        - lastName
        - dateOfBirth
        - details
        - type
      properties:
        firstName:
          type: string
        lastName:
          type: string
        dateOfBirth:
          type: string
          format: date
        details:
          type: object
          additionalProperties: true
          minProperties: 1
        type:
          $ref: "#/components/schemas/individualType"

    Application:
      type: object
      required:
        - applicationId
        - status
        - laaReference
        - lastUpdated
      properties:
        applicationId:
          type: string
          format: uuid
        status:
          $ref: "#/components/schemas/applicationStatus"
        laaReference:
          type: string
        lastUpdated:
          type: string
          format: date-time
        assignedTo:
          type: string
          format: uuid
        submittedAt:
          type: string
          format: date-time
        isLead:
          type: boolean
        useDelegatedFunctions:
          type: boolean
        autoGrant:
          type: boolean
        overallDecision:
          $ref: "#/components/schemas/decisionStatus"
        applicationType:
          $ref: "#/components/schemas/applicationType"
        opponents:
          type: array
          items:
            $ref: "#/components/schemas/Opponent"
        provider:
          type: string

    ApplicationCreateRequest:
      type: object
      required:
        - status
        - applicationContent
        - laaReference
        - individuals
      properties:
        status:
          $ref: "#/components/schemas/applicationStatus"
        applicationContent:
          type: object
          description: Application data to create
          additionalProperties: true
          minProperties: 1
        laaReference:
          type: string
          minLength: 1
        individuals:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/Individual"

    ApplicationUpdateRequest:
      type: object
      required:
        - applicationContent
      properties:
        status:
          $ref: "#/components/schemas/applicationStatus"
        applicationContent:
          type: object
          description: Application data to update
          additionalProperties: true
          minProperties: 1

    ApplicationSummary:
      type: object
      description: (APPLICATION LIST PAGE / VIEW - OPEN APPLICATIONS ONLY BY DEFAULT)
      properties:
        applicationId:
          type: string
          format: uuid
          description: The unique reference used to identify the application.
        status:
          $ref: "#/components/schemas/applicationStatus"
        submittedAt:
          type: string
          format: date-time
        lastUpdated:
          type: string
          format: date-time
        usedDelegatedFunctions:
          type: boolean
        categoryOfLaw:
          $ref: "#/components/schemas/categoryOfLaw"
        matterType:
          $ref: "#/components/schemas/matterType"
        assignedTo:
          type: string
          format: uuid
        autoGrant:
          type: boolean
        clientFirstName:
          type: string
        clientLastName:
          type: string
        clientDateOfBirth:
          type: string
          format: date
        laaReference:
          type: string
        officeCode:
          type: string
        applicationType:
          $ref: "#/components/schemas/applicationType"
        isLead:
          type: boolean

    ApplicationSummaryResponse:
      type: object
      properties:
        paging:
          $ref: "#/components/schemas/Paging"
        applications:
          type: array
          items:
            $ref: "#/components/schemas/ApplicationSummary"
    Caseworker:
      type: object
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string

    EventHistory:
      type: object
      properties:
        eventDescription:
          type: string

    CaseworkerResponse:
      type: array
      items:
        $ref: "#/components/schemas/Caseworker"

    CaseworkerAssignRequest:
      type: object
      required:
        - caseworkerId
        - applicationIds
      properties:
        caseworkerId:
          type: string
          format: uuid
        applicationIds:
          type: array
          minItems: 1
          items:
            type: string
            format: uuid
        eventHistory:
          $ref: "#/components/schemas/EventHistory"

    CaseworkerUnassignRequest:
      type: object
      required:
        - eventHistory
      properties:
        eventHistory:
          $ref: "#/components/schemas/EventHistory"

    ApplicationHistoryResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/ApplicationDomainEvent"

    ApplicationDomainEvent:
      type: object
      required:
        - applicationId
        - domainEventType
        - createdAt
        - createdBy
        - eventDescription
      properties:
        applicationId:
          type: string
          format: uuid
        caseworkerId:
          type: string
          format: uuid
        domainEventType:
          $ref: "#/components/schemas/domainEventType"
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
        eventDescription:
          type: string

    Paging:
      type: object
      properties:
        page:
          type: integer
        pageSize:
          type: integer
        itemsReturned:
          type: integer
        totalRecords:
          type: integer

    IndividualsResponse:
      type: object
      properties:
        paging:
          $ref: "#/components/schemas/Paging"
        individuals:
          type: array
          items:
            $ref: "#/components/schemas/Individual"

    decisionStatus:
      type: string
      enum:
        - PENDING
        - GRANTED
        - PARTIALLY_GRANTED
        - REFUSED

    meritsDecisionStatus:
      type: string
      enum:
        - GRANTED
        - REFUSED

    Certificate:
      type: object
      description: Certificate details. Not required for Refuse decisions.
      required:
        - templateVersion
        - applicationId
        - client
        - provider
        - opponents
        - certificateSummary
        - proceedings
      properties:
        certificateVersion:
          type: integer
          example: 1
          description:
            Version of the certificate
        templateVersion:
          type: integer
          example: 1
          description:
            Version of the certificate template used when generating the
            certificate.
        applicationId:
          type: string
          format: uuid
          example: ab329-00ad-4ef3-91c3-2fdc6d1f3c4e
          description:
            The unique reference used to identify the application associated with
            the certificate.
        client:
          $ref: "#/components/schemas/ClientDetails"
        provider:
          $ref: "#/components/schemas/ProviderDetails"
        opponents:
          description: (CERTIFICATE PAGE)
          type: array
          items:
            $ref: "#/components/schemas/Opponent"
        guardian:
          $ref: "#/components/schemas/Guardian"
        certificateSummary:
          $ref: "#/components/schemas/CertificateSummary"
        proceedings:
          description: (CERTIFICATE PAGE)
          type: array
          items:
            $ref: "#/components/schemas/CertificateProceedingDetails"

    ClientDetails:
      type: object
      required:
        - firstName
        - lastName
        - correspondenceAddress
      properties:
        firstName:
          type: string
        lastName:
          type: string
        correspondenceAddress:
          $ref: "#/components/schemas/Address"

    ProviderDetails:
      type: object
      required:
        - firmName
        - officeAddress
      properties:
        firmName:
          type: string
          example: Jane & Co.
          description: Name of the firm.
        officeAddress:
          $ref: "#/components/schemas/Address"

    Opponent:
      type: object
      description:
        All applications must contain at least one
        opponent.  There can be more than one.  The opponent can be an individual
        (consisting of a first and last name) or an organisation (consisting of an
        organisation name and type. For SCA, most, if not all, opponents will be
        organisations.
      required:
        - firstName
        - lastName
        - organisation
      properties:
        firstName:
          type: string
          example: null
        lastName:
          type: string
          example: null
        organisation:
          type: string
          example: Manchester City Council

    Guardian:
      type: object
      description: Only if applicable
      required:
        - firstName
        - lastName
        - correspondenceAddress
      properties:
        firstName:
          type: string
          description: First name of the guardian
        lastName:
          type: string
          description: Last name of the guardian
        correspondenceAddress:
          $ref: "#/components/schemas/Address"

    CertificateSummary:
      type: object
      required:
        - certificateId
        - certificateType
        - certificateIssueDate
        - certificateStatusCode
        - substantiveCostLimitation
        - startDate
        - costLimitEffectiveDate
      properties:
        certificateId:
          type: string
          format: uuid
        certificateType:
          $ref: "#/components/schemas/CertificateType"
        certificateIssueDate:
          type: string
          format: date-time
        certificateStatusCode:
          $ref: "#/components/schemas/CertificateStatus"
        substantiveCostLimitation:
          type: integer
          example: 25000
        startDate:
          type: string
          format: date-time
          description:
            This is the start date of a certificate - usually different from 
            "certificateIssueDate" as it depends on e.g. delegated functions.
        endDate:
          type: string
          format: date-time
          description: This is the end date of a certificate.
        reinstatementDate:
          type: string
          format: date-time
          description: This is the date when a certificate was reinstated, if applicable.
        costLimitEffectiveDate:
          type: string
          format: date-time
          description: Date the cost limit is effective from.
        certificateLimitationDate:
          type: string
          format: date-time
          description:
            Date that the certificate is limited to. Will not be provided for MVP.
    CertificateType:
      example: SUBSTANTIVE
      description:
        Type of certificate to be issued. Only SUBSTANTIVE needed for SCA
      enum:
        - SUBSTANTIVE

    CertificateStatus:
      example: CLOSED
      description:
        This is the status of the certificate as defined by Decide, this can
        change over time for example when a certificate is closed.
      enum:
        - LIVE
        - CLOSED

    ProceedingStatus:
      example: CLOSED
      description:
        This is the status of the proceeding as defined by Decide, this can
        change over time for example when a certificate is closed.
      enum:
        - LIVE
        - CLOSED

    CertificateProceedingDetails:
      type: object
      required:
        - proceedingId
        - proceedingDescription
        - proceedingType
        - categoryOfLaw
        - matterType
        - levelOfService
      properties:
        proceedingId:
          type: string
          format: uuid
          example: PRC1
          description: Auto generated unique identifier.
        proceedingDescription:
          type: string
          description:
            Description of the proceeding type, provides additional context and should 
            be the full description e.g. ’to be represented on a court hearing for a supervision order’
        proceedingType:
          $ref: "#/components/schemas/ProceedingType"
        proceedingStatus:
          $ref: "#/components/schemas/ProceedingStatus"
        categoryOfLaw:
          $ref: "#/components/schemas/CategoryOfLaw"
        matterType:
          $ref: "#/components/schemas/MatterType"
        levelOfService:
          $ref: "#/components/schemas/LevelOfService"
        delegatedFunctionsUsedDate:
          type: string
          format: date-time
          description:
            If the provider has used delegated functions for a proceeding they
            declare the date here. Unlike other matter types, SCA uses the
            delegated function date to backdate the substantive application when
            issuing a certificate.  There is no 'emergency element' to the
            application.
        proceedingEndDate:
          type: string
          format: date-time
          description: Date when proceeding ended.
        clientInvolvementType:
          type: string
          enum: [SUBJECT_CHILD, RESPONDENT]
          example: respondent
          description:
            One is selected for each proceeding.  For SCA the most common would be
            'subject child' or 'respondent'.
        levelOfServiceEffectiveDate:
          type: string
          format: date-time
          description: Start date of the level of service.
        meritsDecision:
          type: string
          enum: [PENDING, GRANTED, REFUSED, REJECTED]
        previousLevelOfService:
          type: string
          enum: ["FULL_REPRESENTATION"]
          description: The previous level of service, if any.
        previousLevelOfServiceEffectiveDate:
          type: string
          format: date-time
          description: Start date of the previous level of service.
        scopeDescription:
          type: string
          example: Default scope for SCA proceedings.
          description: The full description of the scope limitation.
        scopeLimitation:
          type: string
          enum: [FINAL_HEARING]
          description:
            The apply service only permits selection of the default proceeding
            scope for SCA.  There is only one for each proceeding because the
            apply service limits the selection to default only, which is "final
            hearing" for SCA applications. For other matter types there may be
            more than one for each proceeding.
        limitationEffectiveDate:
          type: string
          format: date-time
          description: Date from which the scope limitation starts.
        limitationEndDate:
          type: string
          format: date-time
          description: Date when the scope limitation ends.

    LevelOfService:
      type: string
      enum:
        - FULL_REPRESENTATION
      description:
        This is the 'level of service'.  The apply service only permits selection
        of the default level for SCA which is "full representation".  There is one
        for each proceeding.

    CategoryOfLaw:
      description: The category of law for the application.
      type: string
      enum:
        - FAMILY
      example: FAMILY

    MatterType:
      description: The type of matter for the application.
      type: string
      enum:
        - SPECIAL_CHILDREN_ACT
      example: SPECIAL_CHILDREN_ACT

    ProceedingType:
      description:
        Type of proceeding order, which can only be one from a pre-determined
        list.
      type: string
      example: SCA_SUPERVISION_ORDER
      enum:
        - CARE_ORDER
        - CHILD_ASSESSMENT_ORDER
        - CHILD_ARRANGEMENTS_ORDER_CONTACT
        - ARRANGEMENTS_ORDER_RESIDENCE
        - CONTACT_WITH_A_CHILD_IN_CARE
        - CONTACT_ORDER_VARY_OR_DISCHARGE
        - END_CONTACT_WITH_A_CHILD_IN_CARE
        - EMERGENCY_PROTECTION_ORDER
        - EMERGENCY_PROTECTION_ORDER_EXTEND
        - EMERGENCY_PROTECTION_ORDER_DISCHARGE
        - PARENTAL_RESPONSIBILITY
        - PLACEMENT_ORDER
        - PROHIBITED_STEPS_ORDER
        - PROHIBITED_STEPS_ORDER_VARY_OR_DISCHARGE
        - RECOVERY_OF_CHILDREN_ORDER
        - RESIDENCE_VARY_OR_DISCHARGE
        - SCA_SUPERVISION_ORDER
        - SECURE_ACCOMMODATION_ORDER
        - SPECIAL_GUARDIANSHIP_ORDER
        - SPECIFIC_ISSUE_ORDER
        - SPECIFIC_ISSUE_ORDER_VARY_OR_DISCHARGE

    MeritsDecisionDetails:
      type: object
      required:
        - decision
        - justification
      properties:
        decision:
          $ref: "#/components/schemas/meritsDecisionStatus"
        reason:
          type: string
          description: Required if the decision is "Refuse"
        justification:
          type: string
          description: Required if the decision is "Refuse"

    MakeDecisionProceeding:
      type: object
      required:
        - proceedingId
        - meritsDecision
      properties:
        proceedingId:
          type: string
          format: uuid
        meritsDecision:
          $ref: "#/components/schemas/MeritsDecisionDetails"

    MakeDecisionRequest:
      type: object
      required:
        - userId
        - overallDecision
        - proceedings
        - eventHistory
        - autoGranted
      properties:
        userId:
          type: string
          format: uuid
        autoGranted:
          type: boolean
        overallDecision:
          $ref: "#/components/schemas/decisionStatus"
        proceedings:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/MakeDecisionProceeding"
        certificate:
          $ref: "#/components/schemas/Certificate"
        eventHistory:
          $ref: "#/components/schemas/EventHistory"

    Address:
      type: object
      required:
        - addressLineOne
        - postcode
        - countryCode
      properties:
        buildingNumberName:
          type: string
        addressLineOne:
          type: string
        addressLineTwo:
          type: string
        addressLineThree:
          type: string
        city:
          type: string
        county:
          type: string
        postcode:
          type: string
        countryCode:
          type: string
        careOfType:
          $ref: "#/components/schemas/CareOfType"
        careOfFirstName:
          type: string
        careOfLastName:
          type: string
        careOfOrganisationName:
          type: string

    CareOfType:
      type: string
      enum:
        - "ORGANISATION"
        - "INDIVIDUAL"
